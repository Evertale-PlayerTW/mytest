<!DOCTYPE html>
<html lang="zh-Hant">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<link rel="icon" type="image/png"
		href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAC91BMVEUAAAAsIylCOj9VTlI1JyhBOTy1n5EvJCZJPEM3LjUlHR85LzhdUFU/MDInHiNBNDc6MTc1LDFWSkU/NjoZFhkeFxijfVk9LS8vJCxnW195al4uJSkyJyo/Mjc8MjgeFxwZERFCOUATERNlXV3y47F2XVRCN0Oukmbn2sBwZGQpHiHGuZQ7LCzLwalIODouJSYpICB3XkjBvKNFNDQqISKWiXaqm5UZExVmVlofGh8fFxlpUUGBe3hYUU1jXmT/6dBUPj5LNzlEMjM7KyxpTktOOjtALzBvUlFQOzx8XldFLjU0JiiFZFxHNTYxIyT++uz/5s3+4clpXWiLaF5bQkE2Jyz9893/69Lx5cv228X52sTl1b/eybOTi42gioWJfoSWdm5uY2pvYF2CYVlsWlluVExkTEpeRURXQkA9NUBoQT00LDlBLzdSNTYmIS8rICH69Obs6OPi3Nf36c/e1c7QysjOxcDEvLi5sK65pZqyi32TgH1/dnmAc3Cvd2yTb2OMbGOabWCdZ1xaTlx/XFmUZ1hRSFZkUlV6VVOIa1FeUVF2VE1iSUE4MD5HOjtjOzZkLTY3LDMkGh3+/PH49e/+/OT++t/n4dz38Nbx6dP99tL69Mrc18Pz5cD+9r3Qybrp2rXNvbXbwrDauqjluqVdjJbx1pXYv5Kjj4/lm4zIpouumYumlYbUkIXDiXyvlHFtZm+jcmuee2qlh2izbGekbGZ9a2VgVWSNd2OdhWBzZGCHaFt9ZlR3WFSEW1OqU1J7YlGCUUpOQUd0WkWIXkNoSUNrVUKYOUF2UDwsJDRMMDA4Iyv27eDo4dLl3NLl2Mj25sXq2sLuzrr877asvLWbs7C9uaL98KG/rqHiyp6vpZ3Xxpy/rpmXhJCwm47TsYzOmoq5k4W6poSThYKUg4LcwIF+cHaNgHSGf3O6fXKbiG+pgW9/a2y3hlqocVpLRlkzS1d0XFVrWVSccEuMUUu5QkqESkhiSUcwPUdyW0ajPESUS0OJNT5j/bk9AAAAP3RSTlMA/h0L70/+8ikQ9O/st6qJal9KSC8U/fjl5OPUspx4aEg8PDT+/fz49vHx6enf39ra1s3IxK2bmI2HhIB+Y1QrMBUfAAAC80lEQVQ4y2KgMmAVVlAQZWLFIatkziftHerNIq4jKMqMRZ7Jissrx8nVwcHXyc2bF1NeUcLb2cnV0dc13cPJ14FFGV2emc/by8vZ1cOhZa+Dq5ujBwu6Q/gZ3dxcQ9xdgt3TXBzcHdKdnXlRDFECiJHRycE3w8PJ3aU+YZNLaqpvqACKAfImbq6ODsmpe7+7uFf5JO/28XC0RFHAwe7l6JDu5OZZ7+7p6b7Jx8XDWUsESZ6Tj3GiY4ijS4hncLrP6+DkFncPLwFkBaLSjKHOzhlHu4N3N3R0dNc/9HF0skD2o7ws46R8x4yQjuQlCSFZ6xbdc3F05kcNRsZJ3n6hrhP7gh2c9jWkLPZwY0ENbQFGRj+/NLalS3e5uTz48aHLyc8ANZwAEubOT/NNK54/5/mqS4FXrsY453OhxZQgl2uLY3RYcXS4vb19QMwkb1YmtLDWz3fyWRxuH24fBcRr/Nit0WNLht3ZISoAqD0KiD+xGIsJgcIHyaVCcuJ+DYEBkZGRAfZsejKGKepAFXIcikihKct+qioqMBAozy3xs703Q1VQWJJVEuxCU20jO2B88Gc1bVwSGFkVmndsx6GTeZ5qPDWaPCCtUo8WTJttw8DMe+Ldy60bG1uP9a1Pyj6ZyZOYWFNbysBhBggFAfr+LaDldHGdJD0Uy0qKFq2ufrXDwLZpawtSg11fd3d1AChYlZrTT3Ccp9sakZCQarSprX6PwIaNbEaOUl1ddnZ4AFiTT57Xm3CYrLjW74ZskPy0qb/K8WmNbG1tSrZ4cpeXAFiUT5Wek3Od3GLosLC3xPv69cePiWluy8WPbYxecpRxAJnOT0+aVqamq2S6UmHme7Ptv8fIh7lrbYWBasK8oXdxAFh0VlaW0Keze1Jihnzj5Hl76rmMg2S8i9+qhYqJ2HJ2AFtc0Vtcr4lgmdpig1+feKLdqEnD7GFJwdl+gmtlq3R1AM8GXl5gxF7NcMx9Ul+YeXmhqIHz9Ie3voL2wW6MfV1fBUcTM3p5mhoAAAAASUVORK5CYII=" />
	<title>「亙苦妄想」花名冊</title>
	<style>
		body {
			width: min(100%, 800px);
			margin: auto;
			padding: 0.5rem;
			box-sizing: border-box;
			font-family: "Noto Sans TC", "Noto Sans CJK TC", "Microsoft JhengHei", "PingFang TC", "Segoe UI", sans-serif;
		}

		a {
			color: inherit;
			text-decoration: none;
		}

		.chooseOption {
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 3px 0;
		}

		.chooseOption label {
			flex: 1;
			text-align: center;
		}

		#filterRarity,
		#filterElement,
		#filterWeaponType,
		#filterStars {
			border: 1px solid black;
			margin: 5px 0;
			padding: 5px;
			position: relative;
		}

		.toggleAll {
			position: absolute;
			top: 0;
			left: -0.4em;
			border: none;
			background: transparent;
			width: max(3%, 1em);
			height: 100%;
			padding: 0;
			font: inherit;
		}

		.toggleAll::before {
			position: absolute;
			content: "";
			top: 50%;
			left: 0;
			background-color: gray;
			border-radius: 50%;
			width: 0.8em;
			height: 1.2em;
			transform: translateY(-50%);
		}

		#targetSelect {
			width: 100%;
			height: 2em;
			margin: 10px auto;
			font-size: 1em;
			font-family: inherit;
		}

		/* Chrome, Safari, Edge */
		input[type="number"]::-webkit-outer-spin-button,
		input[type="number"]::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}

		/* Firefox */
		input[type="number"] {
			appearance: textfied;
			-moz-appearance: textfield;
		}

		select {
			appearance: none;
			-webkit-appearance: none;
			-moz-appearance: none;
			text-align: center;
			text-align-last: center;
			-moz-text-align-last: center;
		}

		option:first-child {
			text-align: center;
			text-align-last: center;
			-moz-text-align-last: center;
		}

		option:not(:first-child) {
			text-align: left;
		}

		.hidden {
			display: none !important;
		}

		hr {
			margin: 1.5em -0.5em 2em -0.5em;
		}

		#nameDisplay {
			position: relative;
		}

		#bigName {
			text-align: center;
			font-size: 3em;
			font-weight: bold;
		}

		#subName {
			text-align: center;
			font-size: 1.5em;
		}

		#codeName {
			position: absolute;
			top: -4em;
			right: 0px;
			font-size: 0.5em;
		}

		#viewContent {
			padding: 0.5em;
			margin-top: 2em;
		}

		#generalStatsArea {
			width: min(100%, 400px);
			margin: auto;
			padding: 0 0.5rem;
			border: 1px solid black;
			box-sizing: border-box;
		}

		.infoRow {
			display: flex;
			align-items: center;
			margin: 0.5rem auto;
		}

		.infoTitle {
			width: 30%;
			border: 1px solid black;
			text-align: justify;
			text-align-last: justify;
			padding: 0.2em;
		}

		.infoValue {
			width: 70%;
			text-align: center;
		}

		.areaTitle {
			text-align: center;
			font-size: 2em;
		}

		.contentBox {
			position: relative;
			border: 1px solid black;
			padding: 0.5em;
			min-height: 1.5em;
			box-sizing: border-box;
		}

		#hasAscended {
			margin-top: 1.5em;
		}

		#profileAscendedTitle {
			border: 1px solid black;
			font-size: 1.2em;
			width: 50%;
			text-align: justify;
			text-align-last: justify;
			margin: 0.5em auto;
		}

		#leaderSkillName,
		#weaponSkillName {
			border: 1px solid black;
			display: inline-block;
			margin: 0 auto 0.3em 1em;
			padding: 0 0.2em;
		}

		#activeSkillContent,
		#passiveSkillContent,
		#dialogContent,
		#relationshipContent {
			display: flex;
			flex-direction: column;
			gap: 0.5em;
		}

		.activeSkillDetail,
		.passiveSkillDetail {
			display: grid;
			grid-template-columns: 1fr minmax(10%, max-content) minmax(10%, max-content);
			align-items: center;
			border: 1px solid black;
			padding: 0.5em;
			gap: 0.4em;
		}

		.activeSkillName,
		.passiveSkillName,
		.relationshipName {
			display: inline-block;
			margin-left: 1em;
			border: 1px solid black;
			padding: 0 0.2em;
			width: fit-content;
		}

		.activeSkillSpirit,
		.activeSkillTU {
			text-align: center;
			border: 1px solid black;
			border-radius: 1em;
			height: 100%;
			place-content: center;
			padding: 0 0.5em;
		}

		.activeSkillDecription,
		.passiveSkillDecription,
		.relationshipMembers {
			grid-column: 1 / -1;
		}

		#dialogContent {
			gap: 1em;
		}

		.dialogGroupTitle {
			text-align: center;
			font-size: 1.2em;
		}

		.dialogText {
			border: 1px solid black;
			margin-top: 0.5em;
			padding: 0.5em;
		}

		label:has(input:disabled) {
			opacity: 0.5;
			pointer-events: none;
			cursor: not-allowed;
		}

		.relationshipAGroup {
			display: grid;
			grid-template-columns: 1fr 5em;
			align-items: center;
			border: 1px solid black;
			padding: 0.5em;
		}

		.relationshipBonus {
			text-align: center;
			border: 1px solid black;
			border-radius: 5em;
			height: 100%;
			place-content: center;
			padding: 0 0.5em;
			line-height: 1.1;
		}

		.relationshipAGroup ul {
			margin: 0.5em 1em;
			padding-left: 0.5em;
		}

		.collapseButton {
			position: absolute;
			left: 0;
			top: -0.25rem;
			background-color: transparent;
			border: 0;
			padding: 0;
			line-height: 1;
			transform: translate(-50%, -100%);
		}

		#dataProgress table * {
			border: 1px solid black;
		}

		#dataProgress table {
			border-collapse: collapse;
			border: 1px solid black;
			width: min(100%, 400px);
			margin: auto;
			text-align: center;
		}

		#selectableList {
			display: grid;
			grid-template-columns: 1fr auto;
			align-items: center;
		}

		#siteSetting {
			text-align: right;
			font-size: 0.8em;
		}
	</style>
</head>

<body>
	<div id="siteSetting">
		<label>
			<span>快取保留時間(分鐘)：</span>
			<input id="cacheAge" type="number" min="0" value="60" style="width: 2em"
				onchange="changeCacheExpiryTime(this.value)" />
		</label>
	</div>
	<hr style="margin-top: 0.5em; margin-bottom: 5px" />
	<div id="dataProgress">
		<table>
			<colgroup>
				<col style="width:60%">
				<col style="width:40%">
			</colgroup>
			<tbody>
				<tr id="languageProgressRow">
					<td>語言文本</td>
					<td id="languageProgress">等待</td>
				</tr>
				<tr id="monsterProgressRow">
					<td>角色資料</td>
					<td id="monsterProgress">等待</td>
				</tr>
				<tr id="weaponProgressRow">
					<td>武器資料</td>
					<td id="weaponProgress">等待</td>
				</tr>
				<tr id="equipmentProgressRow">
					<td>飾品資料</td>
					<td id="equipmentProgress">等待</td>
				</tr>
			</tbody>
		</table>
	</div>
	<div class="hidden" id="filterArea">
		<div class="chooseOption" id="selectCategory">
			<label><input type="radio" name="unit_category" value="Monster" onchange="changeCategory()"
					checked />角色</label>
			<label><input type="radio" name="unit_category" value="Weapon" onchange="changeCategory()" />武器</label>
			<label><input type="radio" name="unit_category" value="Equipment" onchange="changeCategory()" />飾品</label>
		</div>

		<div id="filterRarity">
			<button class="toggleAll" onclick="toggleAllCheckboxes(this)"></button>
			<div class="chooseOption">
				<label><input type="checkbox" value="N" onchange="setSelectableList(this)" checked />N</label>
				<label><input type="checkbox" value="R" onchange="setSelectableList(this)" checked />R</label>
				<label><input type="checkbox" value="SR" onchange="setSelectableList(this)" checked />SR</label>
				<label><input type="checkbox" value="SSR" onchange="setSelectableList(this)" checked />SSR</label>
			</div>
		</div>

		<div id="filterStars">
			<button class="toggleAll" onclick="toggleAllCheckboxes(this)"></button>
			<div class="chooseOption">
				<label><input type="checkbox" value="0" onchange="setSelectableList(this)" checked />0★</label>
				<label><input type="checkbox" value="1" onchange="setSelectableList(this)" checked />1★</label>
				<label><input type="checkbox" value="2" onchange="setSelectableList(this)" checked />2★</label>
				<label><input type="checkbox" value="3" onchange="setSelectableList(this)" checked />3★</label>
				<label><input type="checkbox" value="4" onchange="setSelectableList(this)" checked />4★</label>
				<label><input type="checkbox" value="5" onchange="setSelectableList(this)" checked />5★</label>
				<label><input type="checkbox" value="6" onchange="setSelectableList(this)" checked />6★</label>
			</div>
		</div>

		<div id="filterElement" class="mo">
			<button class="toggleAll" onclick="toggleAllCheckboxes(this)"></button>
			<div class="chooseOption">
				<label><input type="checkbox" value="Fire" onchange="setSelectableList(this)" checked />火</label>
				<label><input type="checkbox" value="Water" onchange="setSelectableList(this)" checked />水</label>
				<label><input type="checkbox" value="Earth" onchange="setSelectableList(this)" checked />地</label>
				<label><input type="checkbox" value="Air" onchange="setSelectableList(this)" checked />雷</label>
				<label><input type="checkbox" value="Life" onchange="setSelectableList(this)" checked />光</label>
				<label><input type="checkbox" value="Death" onchange="setSelectableList(this)" checked />闇</label>
			</div>
		</div>

		<div id="filterWeaponType" class="wo" style="display: none">
			<button class="toggleAll" onclick="toggleAllCheckboxes(this)"></button>
			<div class="chooseOption" id="filterWeaponTypeYellow">
				<label><input type="checkbox" value="Sword" onchange="setSelectableList(this)" checked />單手劍</label>
				<label><input type="checkbox" value="Axe" onchange="setSelectableList(this)" checked />單手斧</label>
				<label><input type="checkbox" value="Staff" onchange="setSelectableList(this)" checked />法杖</label>
				<label><input type="checkbox" value="Mace" onchange="setSelectableList(this)" checked />釘頭鎚</label>
			</div>

			<div class="chooseOption" id="filterWeaponTypeRed">
				<label><input type="checkbox" value="GreatSword" onchange="setSelectableList(this)"
						checked />雙手劍</label>
				<label><input type="checkbox" value="GreatAxe" onchange="setSelectableList(this)" checked />雙手斧</label>
				<label><input type="checkbox" value="Spear" onchange="setSelectableList(this)" checked />長槍</label>
				<label><input type="checkbox" value="Hammer" onchange="setSelectableList(this)" checked />大槌</label>
				<label><input type="checkbox" value="Katana" onchange="setSelectableList(this)" checked />武士刀</label>
			</div>
		</div>

		<div id="selectableList">
			<select id="targetSelect" onchange="displayData()">
				<option value="" disabled selected hidden>▼ 選擇目標 ▼</option>
			</select>
			<label><input type="checkbox" id="reverseToggle" onchange="reverseOptions()" value="false" />反序</label>
		</div>
	</div>
	<hr style="margin: 1em -0.5em auto" />
	<div id="mainBlock" style="padding-top: 2em">
		<div id="nameDisplay">
			<div id="subName"></div>
			<div id="bigName"></div>
			<div id="codeName"></div>
		</div>

		<div id="viewContent">
			<div class="hidden" id="generalStatsArea">
				<div class="infoRow hidden" id="rarity">
					<div class="infoTitle">稀有度</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="stars">
					<div class="infoTitle">星數</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="preferredWeapon">
					<div class="infoTitle">擅長武器</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="weaponType">
					<div class="infoTitle">武器類型</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="element">
					<div class="infoTitle">屬性</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="cost">
					<div class="infoTitle" style="text-align: center; text-align-last: center">Cost</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="atk">
					<div class="infoTitle">攻擊力</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="hp">
					<div class="infoTitle">生命</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="speed">
					<div class="infoTitle">速度</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="power">
					<div class="infoTitle">
						<div>戰力</div>
						<div id="powerHint" style="text-align: center; text-align-last: center; font-size: 0.7em">
							(基礎能力值估算)
						</div>
					</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="freeEvo">
					<div class="infoTitle">自動進化</div>
					<div class="infoValue"></div>
				</div>
				<div class="infoRow hidden" id="visible">
					<div class="infoTitle">圖鑑可見</div>
					<div class="infoValue"></div>
				</div>
			</div>

			<div class="hidden" id="gachaIntroArea">
				<hr />
				<div class="areaTitle" id="profileTitle">召喚導言</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="gachaIntroContent">
						<div id="gachaIntroText" style="text-align: center"></div>
					</div>
				</div>
			</div>

			<div class="hidden" id="profileArea">
				<hr />
				<div class="areaTitle" id="profileTitle">簡介</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="profileContent">
						<div id="profileText"></div>
					</div>
				</div>
			</div>

			<div class="hidden" id="leaderSkillArea">
				<hr />
				<div class="areaTitle" id="leaderSkillTitle">隊長技能</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="leaderSkillContent">
						<div id="leaderSkillName"></div>
						<div id="leaderSkillDecription"></div>
					</div>
				</div>
			</div>

			<div class="hidden" id="weaponSkillArea">
				<hr />
				<div class="areaTitle" id="weaponSkillTitle">武器技能</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="weaponSkillContent">
						<div id="weaponSkillName"></div>
						<div id="weaponSkillDecription"></div>
					</div>
				</div>
			</div>

			<div class="hidden" id="activeSkillArea">
				<hr />
				<div class="areaTitle" id="activeSkillTitle">主動技能</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="activeSkillContent"></div>
				</div>
			</div>

			<div class="hidden" id="passiveSkillArea">
				<hr />
				<div class="areaTitle" id="passiveSkillTitle">被動技能</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="passiveSkillContent"></div>
				</div>
			</div>

			<div class="hidden" id="summonableMonstersArea">
				<hr />
				<div class="areaTitle" id="summonableMonstersTitle">召喚物</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="summonableMonstersContent"></div>
				</div>
			</div>

			<div class="hidden" id="dialogArea">
				<hr />
				<div class="areaTitle" id="dialogTitle">對話</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="dialogContent"></div>
				</div>
			</div>

			<div class="hidden" id="aiLogicArea">
				<hr />
				<div class="areaTitle" id="aiLogicTitle">AI邏輯</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="aiLogicContent" style="white-space: pre-wrap"></div>
				</div>
			</div>

			<div class="hidden" id="relationshipArea">
				<hr />
				<div class="areaTitle" id="relationshipTitle">夥伴</div>
				<div class="contentBox">
					<button class="collapseButton" onclick="collapseContent(this)">⊖</button>
					<div id="relationshipContent"></div>
				</div>
			</div>
		</div>
	</div>

	<template id="template-hasAscended">
		<div id="hasAscended">
			<div id="profileAscendedTitle">・超越・</div>
			<div id="profileAscendedText"></div>
		</div>
	</template>

	<template id="template-activeSkill">
		<div class="activeSkillDetail">
			<div class="activeSkillName"></div>
			<div class="activeSkillSpirit"></div>
			<div class="activeSkillTU"></div>
			<div class="activeSkillDecription"></div>
		</div>
	</template>

	<template id="template-passiveSkill">
		<div class="passiveSkillDetail">
			<div class="passiveSkillName"></div>
			<div></div>
			<div></div>
			<div class="passiveSkillDecription"></div>
		</div>
	</template>

	<template id="template-dialog">
		<div class="dialogGroup">
			<div class="dialogGroupTitle"></div>
			<div class="dialogText"></div>
		</div>
	</template>

	<template id="template-relationship">
		<div class="relationshipAGroup">
			<div class="relationshipName"></div>
			<div class="relationshipBonus"></div>
			<div class="relationshipMembers"></div>
		</div>
	</template>

	<script>
		let unit_category = document.querySelector('input[name="unit_category"]:checked').value;
		let currentDisplayCategory = null;
		let wholeData = {};

		document.addEventListener("DOMContentLoaded", function () {
			const url = new URL(window.location.href);
			if (url.searchParams.has("lang")) {
				url.pathname = url.pathname.replace(/Viewer\d*/, "Viewer3");
				window.location.href = url.toString();
			}
		});

		document.addEventListener("DOMContentLoaded", function () {
			if (localStorage.getItem("cacheAge")) document.getElementById("cacheAge").value = localStorage.getItem("cacheAge");
		});
		document.addEventListener("DOMContentLoaded", initPage);

		async function initPage() {
			await initFilter();
			await loadWholeData();
			await setSelectableList();
			await analyzeUrlParams();
		}

		function changeCacheExpiryTime(cacheAge) {
			if (cacheAge <= 0) {
				localStorage.setItem("cacheExpiryTimestamp", 0);
				location.reload();
			} else {
				const cacheDuration = cacheAge * 60 * 1000;
				localStorage.setItem("cacheExpiryTimestamp", (cacheDuration + Date.now()).toString());
				localStorage.setItem("cacheAge", cacheAge);
			}
		}
	</script>

	<script>
		/*=====篩選邏輯區塊=====*/

		const initSelectOptionContent = document.getElementById("targetSelect").innerHTML;

		function initFilter() {
			document.getElementById("selectCategory").querySelector('input[type="radio"]').checked = true;
			document.querySelectorAll('input[type="checkbox"]').forEach((c) => (c.checked = true));
			document.getElementById("reverseToggle").checked = false;
		}

		function changeCategory() {
			unit_category = document.querySelector('input[name="unit_category"]:checked').value;

			document.querySelectorAll(".mo, .wo").forEach(function (el) {
				el.style.display = "none";
			});

			if (unit_category === "Equipment") {
			} else {
				if (unit_category === "Weapon") {
					document.querySelectorAll(".wo").forEach(function (el) {
						el.style.display = "";
					});
				} else {
					document.querySelectorAll(".mo").forEach(function (el) {
						el.style.display = "";
					});
				}
			}

			document.querySelectorAll('.chooseOption input[type="checkbox"]').forEach((el) => (el.checked = true));
			document.getElementById("reverseToggle").checked = false;

			setSelectableList();
		}

		function setSelectableList(triggerElement) {
			const targetSelect = document.getElementById("targetSelect");
			targetSelect.innerHTML = initSelectOptionContent;

			const selectedRarities = Array.from(document.querySelectorAll("#filterRarity input:checked")).map(
				(cb) => cb.value
			);
			const selectedStars = Array.from(document.querySelectorAll("#filterStars input:checked")).map((cb) => cb.value);
			const selectedElements = Array.from(document.querySelectorAll("#filterElement input:checked")).map((cb) =>
				cb.parentNode.textContent.trim()
			);
			const selectedWeaponTypes = Array.from(document.querySelectorAll("#filterWeaponType input:checked")).map((cb) =>
				cb.parentNode.textContent.trim()
			);

			const filteredStars = new Set();

			for (const id in wholeData[unit_category]) {
				const entry = wholeData[unit_category][id];
				const option = document.createElement("option");

				if (!selectedRarities.includes(entry["稀有度"])) continue;
				if (unit_category === "Monster" && !selectedElements.includes(entry["屬性"])) continue;
				if (unit_category === "Weapon" && !selectedWeaponTypes.includes(entry["類型"])) continue;

				filteredStars.add(entry["目前星數"]);
				if (!selectedStars.includes(String(entry["目前星數"]))) continue;

				option.value = id;
				option.text = getFullNameAddStarsOrRarity(id, unit_category, true, false);
				targetSelect.appendChild(option);
			}

			if (document.getElementById("reverseToggle").checked) reverseOptions();
			targetSelect.selectedIndex = 0;

			if (filteredStars.size !== 0) {
				//禁用沒有的星數選項
				Array.from(document.querySelectorAll("#filterStars input")).forEach((cb) => {
					cb.disabled = false;
					if (!filteredStars.has(Number(cb.value))) {
						cb.checked = false;
						cb.disabled = true;
					}
				});

				//若非星數區塊觸發，且星數都未選，則全選
				const selectedStarsNew = Array.from(document.querySelectorAll("#filterStars input:checked")).map(
					(cb) => cb.value
				);
				if (triggerElement && !triggerElement.closest("#filterStars") && selectedStarsNew.length === 0) {
					document.querySelectorAll("#filterStars input").forEach((cb) => (cb.checked = true));
					setSelectableList();
				}
			}
		}

		function reverseOptions() {
			const selectableTarget = document.getElementById("targetSelect");
			const originalOptions = Array.from(selectableTarget.options).slice(1);
			const newOptions = originalOptions.reverse();
			selectableTarget.innerHTML = initSelectOptionContent;
			newOptions.forEach((option) => selectableTarget.appendChild(option));
			selectableTarget.selectedIndex = 0;
		}

		function toggleAllCheckboxes(toggleElement) {
			const checkboxes = toggleElement.parentElement.querySelectorAll('input[type="checkbox"]');

			// 檢查目前是否全選
			const allChecked = Array.from(checkboxes)
				.filter((cb) => !cb.disabled)
				.every((cb) => cb.checked);
			checkboxes.forEach((cb) => (cb.checked = !allChecked));

			setSelectableList();
		}
	</script>

	<script>
		/*=====載入資料區塊=====*/

		const langData = {};
		const weaponType = {};
		const elementType = {};
		const proxyUrl = "https://corsproxy.io/?";
		const resourceUrlPrefix = "https://prd.evertaleserver.com/Prd280/";

		async function loadWholeData() {
			const cacheKey_Data = "cacheWholeData";
			const cacheKey_Time = "cacheExpiryTimestamp";
			const cacheKey_Lang = "cacheLastLang";
			const cacheDuration = document.getElementById("cacheAge").value * 60 * 1000;

			const cache_WholeData = localStorage.getItem(cacheKey_Data);
			const cache_Time = localStorage.getItem(cacheKey_Time);
			if (cache_WholeData && cache_Time && Date.now() < cache_Time && localStorage.getItem("cacheLastLang") === "dataForVer2") {
				wholeData = JSON.parse(cache_WholeData);
			} else {
				await loadLanguageText();
				await Promise.all([buildMonsterData(), buildWeaponData(), buildEquipmentData()]);
				localStorage.setItem(cacheKey_Data, JSON.stringify(wholeData));
				localStorage.setItem(cacheKey_Time, (cacheDuration + Date.now()).toString());
				localStorage.setItem("cacheLastLang", "dataForVer2");
			}

			//console.log(wholeData);
			document.getElementById("dataProgress").classList.add("hidden");
			document.getElementById("filterArea").classList.remove("hidden");
		}

		async function loadLanguageText() {
			const langLink = {
				CHT: `${resourceUrlPrefix}Localization/Localizable_ChineseTraditional.txt`,
				EN: `${resourceUrlPrefix}Localization/Localizable_English.txt`,
			};
			document.getElementById("languageProgress").textContent = "載入中...";
			console.time("Lang");
			try {
				for (const [langKey, filelink] of Object.entries(langLink)) {
					const data = {};
					const responseText = await (await fetchCheck(`${proxyUrl}${filelink}`)).text();
					const lines = responseText.split(/\r?\n/);

					for (let line of lines) {
						const match = line.match(/"(.*)"="(.*)"/);
						if (match) {
							const [, key, value] = match;
							data[key] = value;
						}
					}
					langData[langKey] = data;
				}
				document.getElementById("languageProgress").textContent = "載入完成";
			} catch (error) {
				document.getElementById("languageProgress").textContent = "載入失敗";
				console.error("讀取或解析錯誤:", error);
				alert(error)
				throw error;
			}
			console.timeEnd("Lang");
		}

		async function fetchCheck(url) {
			const response = await fetch(url);
			if (!response.ok) {
				const text = await response.text();
				alert(`HTTP Error ${response.status}: ${response.statusText}\n${text}`);
				throw new Error(`HTTP ${response.status}`);
			}
			return response;
		}


		function getTextByKey(textKey) {
			for (const langKey in langData) {
				if (langData[langKey][textKey]) {
					return langData[langKey][textKey]
						.replace(/\\n/g, "\n")
						.replace(/\\r/g, "\r")
						.replace(/\\t/g, "\t")
						.replace(/\\'/g, "'")
						.replace(/\\"/g, '"')
						.replace(/\\\\/g, "\\");
				}
			}
			return "";
		}

		async function buildEquipmentData() {
			console.time("Equ");
			document.getElementById("equipmentProgress").textContent = "載入中...";
			try {
				const baseEquipmentConfigUrl = `${resourceUrlPrefix}Equipment.json`;
				const baseEquipmentConfig = await fetchCheck(`${proxyUrl}${baseEquipmentConfigUrl}`)
					.then((res) => res.json())
					.then((data) => data["Equipment"]);

				const equipmentData = {};
				for (const entry of baseEquipmentConfig) {
					const equipmentContent = {};
					const entryID = entry["name"];

					equipmentContent["名字"] = getTextByKey(entryID + "NameKey");
					equipmentContent["完整名"] = equipmentContent["名字"] || entryID;
					equipmentContent["簡介"] = getTextByKey(entryID + "DescriptionKey");
					equipmentContent["稀有度"] = getRarity(entry["accessoryStars"]);
					equipmentContent["星數"] = generateStarText(entry["accessoryStars"], entry["accessoryStars"]);
					equipmentContent["目前星數"] = entry["accessoryStars"];
					equipmentContent["最大星數"] = entry["accessoryStars"];
					equipmentContent["攻擊力"] = entry["flatAttack"];
					equipmentContent["生命"] = entry["flatMaxHp"];
					equipmentContent["速度"] = entry["flatSpeed"];
					equipmentContent["戰力"] = calcPowerValEz(
						"Equipment",
						entry["flatAttack"],
						entry["flatMaxHp"],
						entry["flatSpeed"],
						entry["accessoryStars"]
					);
					equipmentContent["圖鑑可見"] = entry["visible"] ? true : false;

					equipmentData[entryID] = equipmentContent;
				}

				wholeData["Equipment"] = equipmentData;
				console.timeEnd("Equ");
				document.getElementById("equipmentProgress").textContent = "載入完成";
			} catch (error) {
				document.getElementById("equipmentProgress").textContent = "載入失敗";
				console.error("讀取或解析錯誤:", error);
				alert(error)
				throw error;
			}
		}

		async function buildWeaponData() {
			console.time("Weap");
			document.getElementById("weaponProgress").textContent = "載入中...";
			try {
				const baseWeaponConfigUrl = `${resourceUrlPrefix}Weapon.json`;
				const baseWeaponConfig = await fetchCheck(`${proxyUrl}${baseWeaponConfigUrl}`)
					.then((res) => res.json())
					.then((data) => data["Weapon"]);

				const weaponData = {};
				for (const entry of baseWeaponConfig) {
					const weaponContent = {};
					const entryID = entry["name"];

					weaponContent["名字"] = getTextByKey(entry["family"] + "01NameKey");
					weaponContent["完整名"] = weaponContent["名字"] || entryID;
					weaponContent["簡介"] = getTextByKey(entry["family"] + "01DescriptionKey");
					weaponContent["稀有度"] = getRarity(entry["evolvedStars"]);
					weaponContent["星數"] = generateStarText(entry["stars"], entry["evolvedStars"]);
					weaponContent["目前星數"] = entry["stars"];
					weaponContent["最大星數"] = entry["evolvedStars"];
					weaponContent["類型"] = getWeaponTypeName(entry["weaponPref"]);
					weaponContent["Cost"] = entry["cost"];
					weaponContent["基礎攻擊力"] = entry["baseAttack"];
					weaponContent["基礎生命"] = entry["baseMaxHp"];
					weaponContent["速度"] = 0;
					weaponContent["戰力"] = calcPowerValEz(
						"Weapon",
						entry["baseAttack"],
						entry["baseMaxHp"],
						0,
						entry["evolvedStars"]
					);
					weaponContent["圖鑑可見"] = entry["visible"] ? true : false;

					const gachaIntroText = getTextByKey(entryID + "GachaIntroText");
					if (gachaIntroText) weaponContent["召喚導言"] = gachaIntroText;

					if (entry["passives"]) {
						weaponContent["武器技能"] = [];
						for (const skillID of Object.values(entry["passives"])) {
							const skillDetail = {};
							skillDetail["技能標題"] = getTextByKey(skillID + "NameKey");
							skillDetail["技能敘述"] = getTextByKey(skillID + "DescriptionKey");
							weaponContent["武器技能"].push(skillDetail);
						}
					}

					weaponData[entryID] = weaponContent;
				}

				wholeData["Weapon"] = weaponData;
				console.timeEnd("Weap");
				document.getElementById("weaponProgress").textContent = "載入完成";
			} catch (error) {
				document.getElementById("weaponProgress").textContent = "載入失敗";
				console.error("讀取或解析錯誤:", error);
				alert(error)
				throw error;
			}
		}

		async function buildMonsterData() {
			console.time("Mons");
			document.getElementById("monsterProgress").textContent = "載入中...";
			try {
				//載入基礎設定
				const baseMonsterConfigUrl = `${resourceUrlPrefix}Monster.json`;
				const baseMonsterConfig = await fetchCheck(`${proxyUrl}${baseMonsterConfigUrl}`)
					.then((res) => res.json())
					.then((data) => data["Monster"]);

				//載入技能設定
				const abilityDataConfigUrl = `${resourceUrlPrefix}Ability.json`;
				const abilityDataConfig = {};
				await fetchCheck(`${proxyUrl}${abilityDataConfigUrl}`)
					.then((res) => res.json())
					.then((data) => {
						for (const ability of data["Ability"]) {
							abilityDataConfig[ability.name] = ability;
						}
					});

				//載入AI威脅度設定
				const aiThreatConfigUrl = `${resourceUrlPrefix}AIThreat.json`;
				const aiThreatConfig = {};
				await fetchCheck(`${proxyUrl}${aiThreatConfigUrl}`)
					.then((res) => res.json())
					.then((data) => {
						for (const aiThreat of data["AIThreat"]) {
							(aiThreatConfig[aiThreat.name] ??= {})[aiThreat.condition] = aiThreat.value;
							//if (!aiThreatConfig[aiThreat.name]) aiThreatConfig[aiThreat.name] = {};
							//aiThreatConfig[aiThreat.name][aiThreat.condition] = aiThreat.value;
						}
					});

				//載入技能AI設定
				const skillAIConfigUrl = `${resourceUrlPrefix}AbilityAI.json`;
				const skillAIConfig = await fetchCheck(`${proxyUrl}${skillAIConfigUrl}`)
					.then((res) => res.json())
					.then((data) => data["AbilityAI"]);

				//開始填入資料
				const monsterData = {};
				for (const entry of baseMonsterConfig) {
					const monsterContent = {};
					const entryID = entry["name"];
					const activeSkillNames = {};

					monsterContent["名字"] = getTextByKey(entryID + "NameKey");
					const name2 = getTextByKey(entryID + "SecondNameKey");
					if (name2 && name2 !== monsterContent["名字"]) monsterContent["副名"] = name2;
					monsterContent["完整名"] = monsterContent["名字"]
						? monsterContent["副名"]
							? `${monsterContent["名字"]} - ${monsterContent["副名"]}`
							: monsterContent["名字"]
						: entryID;
					monsterContent["簡介"] = getTextByKey(entryID + "DescriptionKey");
					if (entry["cosmoName"])
						monsterContent["簡介_已超越(滿覺)"] = getTextByKey(entry["cosmoName"] + "DescriptionKey");
					monsterContent["稀有度"] = getRarity(entry["evolvedStars"]);
					monsterContent["星數"] = generateStarText(entry["stars"], entry["evolvedStars"]);
					monsterContent["目前星數"] = entry["stars"];
					monsterContent["最大星數"] = entry["evolvedStars"];
					monsterContent["擅長武器"] = getWeaponTypeName(entry["weaponPref"]);
					monsterContent["屬性"] = getElementTypeName(entry["element"]);
					monsterContent["Cost"] = entry["cost"];
					monsterContent["基礎攻擊力"] = entry["baseAttack"];
					monsterContent["基礎生命"] = entry["baseMaxHp"];
					monsterContent["速度"] = entry["speed"];
					monsterContent["戰力"] = calcPowerValEz(
						"Monster",
						entry["baseAttack"],
						entry["baseMaxHp"],
						entry["speed"],
						entry["evolvedStars"]
					);
					monsterContent["圖鑑可見"] = entry["visible"] ? true : false;

					if (entry["freeEvolve"]) {
						monsterContent["自動進化"] = {};
						monsterContent["自動進化"]["進化等級"] = entry["freeEvolveLevel"];
						monsterContent["自動進化"]["進化目標"] = entry["freeEvolve"];
					}

					const gachaIntroText = getTextByKey(entryID + "GachaIntroText");
					if (gachaIntroText) monsterContent["召喚導言"] = gachaIntroText;

					if (entry["leaderBuff"]) {
						monsterContent["隊長技能"] = {};
						const skillID = entry["leaderBuff"];
						monsterContent["隊長技能"]["技能標題"] = getTextByKey(skillID + "NameKey");
						monsterContent["隊長技能"]["技能敘述"] = getTextByKey(skillID + "DescriptionKey");
					}

					if (entry["activeSkills"]) {
						monsterContent["主動技能"] = [];
						for (const skillID of Object.values(entry["activeSkills"])) {
							const skillDetail = {};
							//檢查技能設定中有無指定標題Key
							const skillNameKey = (abilityDataConfig[skillID]["nameKey"] ?? skillID) + "NameKey";
							skillDetail["技能標題"] = getTextByKey(skillNameKey);
							activeSkillNames[skillID] = skillDetail["技能標題"]; //另存供AI區備用

							//檢查技能設定中有無指定敘述Key
							const skillDescriptionKey =
								(abilityDataConfig[skillID]["descriptionKey"] ?? skillID) + "DescriptionKey";
							skillDetail["技能敘述"] = getTextByKey(skillDescriptionKey);
							//TU
							skillDetail["TU"] = abilityDataConfig[skillID]["tuCost"] ?? 0;
							//靈氣增減0時必帶+號
							skillDetail["靈氣"] = abilityDataConfig[skillID]["spiritGain"]
								? "+" + abilityDataConfig[skillID]["spiritGain"]
								: abilityDataConfig[skillID]["spiritCost"]
									? "-" + abilityDataConfig[skillID]["spiritCost"]
									: "+0";

							monsterContent["主動技能"].push(skillDetail);
						}
					}
					if (entry["passives"]) {
						monsterContent["被動技能"] = [];
						for (const skillID of Object.values(entry["passives"])) {
							const skillDetail = {};
							skillDetail["技能標題"] = getTextByKey(skillID + "NameKey");
							skillDetail["技能敘述"] = getTextByKey(skillID + "DescriptionKey");
							monsterContent["被動技能"].push(skillDetail);
						}
					}

					if (entry["summonableMonsters"]) {
						monsterContent["召喚物"] = [];
						for (const conjures of entry["summonableMonsters"]) {
							monsterContent["召喚物"].push(conjures);
						}
					}

					const dialogGroup = {};
					const dialogList = {
						gachaVoices: ["Gacha", "召喚"],
						loginVoices: ["Login", "主畫面登入"],
						tapVoices: ["Tap", "主畫面點擊"],
						idleVoices: ["Idle", "主畫面閒置"],
					};
					for (const [dialogType, dialogParams] of Object.entries(dialogList)) {
						if (entry[dialogType]) {
							const dialogSet = [];
							for (const dialogNum of entry[dialogType]) {
								dialogSet.push(getTextByKey(entry["family"] + dialogParams[0] + dialogNum + "Key"));
							}
							dialogGroup[dialogParams[1]] = dialogSet;
						}
					}
					if (Object.keys(dialogGroup).length > 0) monsterContent["對話"] = dialogGroup;

					monsterContent["AI邏輯"] = {};
					monsterContent["AI邏輯"]["盯上權重"] = entry["aiTargetPickWeight"];
					if (aiThreatConfig[entryID]) monsterContent["AI邏輯"]["仇恨值(威脅度)"] = aiThreatConfig[entryID];
					monsterContent["AI邏輯"]["技能使用"] = {};
					for (const [fakeIndex, skillID] of Object.entries(entry["activeSkills"])) {
						const skillAISetting = {};
						const skillAIKey = entry["activeSkillsAI"]?.[fakeIndex]
							? entry["activeSkillsAI"][fakeIndex]
							: abilityDataConfig[skillID]["config"] + "_AI";

						if (skillAIConfig[skillAIKey]["baseAITargetingWeight"])
							skillAISetting["基礎權重"] = skillAIConfig[skillAIKey]["baseAITargetingWeight"];
						if (skillAIConfig[skillAIKey]["globalScalorsToIgnore"])
							skillAISetting["忽略"] = skillAIConfig[skillAIKey]["globalScalorsToIgnore"];
						if (skillAIConfig[skillAIKey]["aiTargetingSourceMonsterConditions"])
							skillAISetting["來源"] = skillAIConfig[skillAIKey]["aiTargetingSourceMonsterConditions"];
						if (skillAIConfig[skillAIKey]["aiTargetingMonsterConditions"])
							skillAISetting["目標"] = skillAIConfig[skillAIKey]["aiTargetingMonsterConditions"];

						monsterContent["AI邏輯"]["技能使用"][activeSkillNames[skillID]] = skillAISetting;
					}

					monsterData[entryID] = monsterContent;
				}

				setRelationshipData(monsterData);

				wholeData["Monster"] = monsterData;
				console.timeEnd("Mons");
				document.getElementById("monsterProgress").textContent = "載入完成";
			} catch (error) {
				document.getElementById("monsterProgress").textContent = "載入失敗";
				console.error("讀取或解析錯誤:", error);
				alert(error)
				throw error;
			}
		}

		async function setRelationshipData(monsterData) {
			let relationshipData;
			try {
				relationshipData = await generateRelationshipData();
			} catch (e) {
				console.log("未能成功獲取夥伴關係", e);
				const relationshipDataUrl = "https://evertale-playertw.github.io/Config/Relationship.json";
				relationshipData = await fetchCheck(relationshipDataUrl).then((res) => res.json());
			}

			for (const [relationID, relationDetail] of Object.entries(relationshipData)) {
				const relationshipName = getTextByKey(relationDetail["Name"]);
				for (const memberID of relationDetail["Families"]) {
					const clanID = memberID.slice(0, -2);
					for (let i = 1; i <= 3; i++) {
						charID = clanID + String(i).padStart(2, "0");
						if (monsterData[charID]) {
							const relationGroup = {};
							relationGroup["夥伴關係"] = relationshipName;
							relationGroup["夥伴成員"] = relationDetail["Families"];
							relationGroup["夥伴加成"] = relationDetail["Bonus"].replace("ATK", "攻擊力").replace("HP", "生命值");
							monsterData[charID]["夥伴"] ??= {};
							monsterData[charID]["夥伴"][relationID] = relationGroup;
						}
					}
				}
			}
		}

		async function getRelationshipRaw() {
			const userDevice = "Google Pixel 6";
			const userOs = "Android OS 13";
			const evtVersion = (
				await fetchCheck(`${proxyUrl}${resourceUrlPrefix}Android/hashes.json`).then((res) => res.json())
			)["ver"];
			const uuid = crypto.randomUUID();

			let uid;
			let clid;
			//從快取讀uid，不然創新帳號獲取
			cache_NewAcc = JSON.parse(localStorage.getItem("NewAcc"));
			if (cache_NewAcc) {
				uid = cache_NewAcc["uid"];
				clid = cache_NewAcc["clid"];
			} else {
				const baseUrl_NewUser = "https://api.prd.evertaleserver.com/newuser";
				const params_NewUser = {
					platform: "android",
					device: userDevice,
					os: userOs,
					adid: "unknown",
					shard: "1",
					req: "newuser",
					lang: "en",
					region: "JST",
					requnique: "1",
				};
				const finalUrl_NewUser = `${proxyUrl}${baseUrl_NewUser}?${new URLSearchParams(params_NewUser).toString()}`;
				const newuserResponse = await fetchCheck(finalUrl_NewUser).then((res) => res.json());
				localStorage.setItem("NewAcc", JSON.stringify(newuserResponse["newuser"]));
				uid = newuserResponse["newuser"]["uid"];
				clid = newuserResponse["newuser"]["clid"];
			}

			//登入以獲取sesid
			const baseUrl_Login = "https://api.prd.evertaleserver.com/login";
			const params_Login = {
				uid: uid,
				clid: clid,
				platform: "android",
				device: userDevice,
				shardpick: "1",
				bundle: "com.zigzagame.evertale",
				ver: evtVersion,
				os: userOs,
				vid: "242f765867a7ee271435177d99fb7749",
				adid: "unknown",
				req: "login",
				lang: "en",
				region: "JST",
				unique: uuid,
				requnique: "1",
			};
			const finalUrl_Login = `${proxyUrl}${baseUrl_Login}?${new URLSearchParams(params_Login).toString()}`;
			const loginResponse = await fetchCheck(finalUrl_Login).then((res) => res.json());
			const sesid = loginResponse["login"]["sesid"];

			//請求獲取Relationship資訊
			const baseUrl_Relationship = "https://api.prd.evertaleserver.com/screenvalues";
			const params_Relationship = {
				screen: "Relationships",
				activeLineup: "1",
				activeEventLineup: "1",
				req: "screenvalues",
				reqid: "1",
				sesid: sesid,
				requnique: "1",
			};
			const finalUrl_Relationship = `${proxyUrl}${baseUrl_Relationship}?${new URLSearchParams(
				params_Relationship
			).toString()}`;
			const relationshipResponse = await fetchCheck(finalUrl_Relationship).then((res) => res.json());

			return relationshipResponse;
		}

		async function generateRelationshipData() {
			const relationshipRaw = JSON.parse((await getRelationshipRaw())["screenvalues"]["relationships"]);
			const relationshipData = {};

			for (const relationDetail of relationshipRaw) {
				const oneRelationship = {};
				oneRelationship["Name"] = relationDetail["locKey"];
				oneRelationship["Families"] = [];
				for (const aMember of relationDetail["families"]) {
					oneRelationship["Families"].push(aMember["Item1"]);
				}
				if (relationDetail["flatAtk"]) oneRelationship["Bonus"] = `ATK+${relationDetail["flatAtk"]}`;
				if (relationDetail["flatHp"]) oneRelationship["Bonus"] = `HP+${relationDetail["flatHp"]}`;
				if (relationDetail["perAtk"]) oneRelationship["Bonus"] = `ATK+${relationDetail["perAtk"]}%`;
				if (relationDetail["perHp"]) oneRelationship["Bonus"] = `HP+${relationDetail["perHp"]}%`;

				relationshipData[relationDetail["name"]] = oneRelationship;
			}
			return relationshipData;
		}

		function getRarity(stars) {
			switch (stars) {
				case 6:
					return "SSR";
				case 5:
					return "SR";
				case 4:
					return "R";
				case 3:
				case 2:
				case 1:
				case 0:
					return "N";
				default:
					return "?";
			}
		}

		function generateStarText(currStar, maxStar) {
			if (maxStar >= currStar) {
				if (maxStar <= 0) {
					return 0;
				} else {
					return "★".repeat(currStar) + "☆".repeat(maxStar - currStar);
				}
			} else {
				return "Stars Error";
			}
		}

		function calcPowerValEz(type, atk, hp, spd, maxStar) {
			const weight_atk = 30;
			const weight_hp = 6;
			const weight_spd = type !== "Equipment" ? 0 : 180;

			let powVal = weight_atk * atk + weight_hp * hp + weight_spd * spd;
			if (type === "Monster") {
				if (maxStar === 6) powVal *= 2;
				if (maxStar === 5) powVal *= 1.5;
			}
			return powVal;
		}

		function getWeaponTypeName(weaponTypeKey) {
			if (!weaponTypeKey) return "-";
			if (weaponType[weaponTypeKey]) return weaponType[weaponTypeKey];
			weaponType[weaponTypeKey] = getTextByKey(weaponTypeKey + "NameKey");
			return weaponType[weaponTypeKey];
		}

		function getElementTypeName(elementTypeKey) {
			if (!elementTypeKey) return "-";
			if (elementType[elementTypeKey]) return elementType[elementTypeKey];
			elementType[elementTypeKey] = getTextByKey(elementTypeKey + "Key");
			return elementType[elementTypeKey];
		}
	</script>

	<script>
		/*=====資訊顯示區塊=====*/

		const initTitle = document.title;

		function displayData(id, myCategory) {
			id ??= document.getElementById("targetSelect").value;
			if (id == "") return;

			currentDisplayCategory = myCategory ?? unit_category;

			collapseReset();
			document.title = `${wholeData[currentDisplayCategory][id]["完整名"]} | ${initTitle}`;

			document.getElementById("codeName").textContent = id;
			document.getElementById("bigName").textContent = wholeData[currentDisplayCategory][id]["名字"] || id;
			if (wholeData[currentDisplayCategory][id]["副名"]) {
				document.getElementById("subName").classList.remove("hidden");
				document.getElementById("subName").textContent = wholeData[currentDisplayCategory][id]["副名"];
			} else {
				document.getElementById("subName").classList.add("hidden");
			}

			setGeneralStats(id);
			setProfile(id);
			setLeaderSkill(id);
			setWeaponSkill(id);
			setActiveSkill(id);
			setPassiveSkill(id);
			setSummonableMonsters(id);
			setGachaIntro(id);
			setDialog(id);
			setAiLogic(id);
			setRelationship(id);

			document.getElementById("mainBlock").scrollIntoView();
		}

		function setGeneralStats(id) {
			document.getElementById("generalStatsArea").classList.remove("hidden");

			if (currentDisplayCategory === "Equipment") {
				document.querySelector("#atk .infoTitle").textContent = "攻擊力";
				document.querySelector("#hp .infoTitle").textContent = "生命";
				document.getElementById("powerHint").classList.add("hidden");
			} else {
				document.querySelector("#atk .infoTitle").textContent = "基礎攻擊力";
				document.querySelector("#hp .infoTitle").textContent = "基礎生命";
				document.getElementById("powerHint").classList.remove("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["稀有度"] != null) {
				document.getElementById("rarity").classList.remove("hidden");
				document.querySelector("#rarity .infoValue").textContent = wholeData[currentDisplayCategory][id]["稀有度"];
			} else {
				document.getElementById("rarity").classList.add("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["星數"] != null) {
				document.getElementById("stars").classList.remove("hidden");
				document.querySelector("#stars .infoValue").textContent = wholeData[currentDisplayCategory][id]["星數"];
			} else {
				document.getElementById("stars").classList.add("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["擅長武器"] != null) {
				document.getElementById("preferredWeapon").classList.remove("hidden");
				document.querySelector("#preferredWeapon .infoValue").textContent =
					wholeData[currentDisplayCategory][id]["擅長武器"];
			} else {
				document.getElementById("preferredWeapon").classList.add("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["類型"] != null) {
				document.getElementById("weaponType").classList.remove("hidden");
				document.querySelector("#weaponType .infoValue").textContent = wholeData[currentDisplayCategory][id]["類型"];
			} else {
				document.getElementById("weaponType").classList.add("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["屬性"] != null) {
				document.getElementById("element").classList.remove("hidden");
				document.querySelector("#element .infoValue").textContent = wholeData[currentDisplayCategory][id]["屬性"];
			} else {
				document.getElementById("element").classList.add("hidden");
			}
			if (wholeData[currentDisplayCategory][id]["Cost"] != null) {
				document.getElementById("cost").classList.remove("hidden");
				document.querySelector("#cost .infoValue").textContent = wholeData[currentDisplayCategory][id]["Cost"];
			} else {
				document.getElementById("cost").classList.add("hidden");
			}

			if (
				(wholeData[currentDisplayCategory][id]["基礎攻擊力"] != null) |
				(wholeData[currentDisplayCategory][id]["攻擊力"] != null)
			) {
				document.getElementById("atk").classList.remove("hidden");
				document.querySelector("#atk .infoValue").textContent =
					wholeData[currentDisplayCategory][id]["基礎攻擊力"] ?? wholeData[currentDisplayCategory][id]["攻擊力"];
			} else {
				document.getElementById("atk").classList.add("hidden");
			}

			if (
				(wholeData[currentDisplayCategory][id]["基礎生命"] != null) |
				(wholeData[currentDisplayCategory][id]["生命"] != null)
			) {
				document.getElementById("hp").classList.remove("hidden");
				document.querySelector("#hp .infoValue").textContent =
					wholeData[currentDisplayCategory][id]["基礎生命"] ?? wholeData[currentDisplayCategory][id]["生命"];
			} else {
				document.getElementById("hp").classList.add("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["速度"] != null) {
				document.getElementById("speed").classList.remove("hidden");
				document.querySelector("#speed .infoValue").textContent = wholeData[currentDisplayCategory][id]["速度"];
			} else {
				document.getElementById("speed").classList.add("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["戰力"] != null) {
				document.getElementById("power").classList.remove("hidden");
				document.querySelector("#power .infoValue").textContent = wholeData[currentDisplayCategory][id]["戰力"];
			} else {
				document.getElementById("power").classList.add("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["自動進化"] != null) {
				document.getElementById("freeEvo").classList.remove("hidden");
				const evoLv = `Lv.${wholeData[currentDisplayCategory][id]["自動進化"]["進化等級"]}`;
				const evoTarget = setNameAndLink(
					wholeData[currentDisplayCategory][id]["自動進化"]["進化目標"],
					"Monster",
					true,
					false
				);
				document.querySelector("#freeEvo .infoValue").innerHTML = `${evoLv}<br>${evoTarget.outerHTML}`;
			} else {
				document.getElementById("freeEvo").classList.add("hidden");
			}

			if (wholeData[currentDisplayCategory][id]["圖鑑可見"]) {
				document.getElementById("visible").classList.remove("hidden");
				document.querySelector("#visible .infoValue").textContent = "✔";
			} else {
				document.getElementById("visible").classList.remove("hidden");
				document.querySelector("#visible .infoValue").textContent = "✗";
			}
		}

		function setProfile(id) {
			if (wholeData[currentDisplayCategory][id]["簡介"]) {
				document.getElementById("profileArea").classList.remove("hidden");
				document.getElementById("profileText").innerText = wholeData[currentDisplayCategory][id]["簡介"];

				document.getElementById("hasAscended")?.remove();
				if (wholeData[currentDisplayCategory][id]["簡介_已超越(滿覺)"] != null) {
					const templateHasAscended = document.getElementById("template-hasAscended").content.cloneNode(true);
					templateHasAscended.getElementById("profileAscendedText").innerText =
						wholeData[currentDisplayCategory][id]["簡介_已超越(滿覺)"];
					document.getElementById("profileContent").appendChild(templateHasAscended);
				}
			} else {
				document.getElementById("profileArea").classList.add("hidden");
			}
		}

		function setLeaderSkill(id) {
			if (wholeData[currentDisplayCategory][id]["隊長技能"]) {
				document.getElementById("leaderSkillArea").classList.remove("hidden");
				document.getElementById("leaderSkillName").innerText =
					wholeData[currentDisplayCategory][id]["隊長技能"]["技能標題"];
				document.getElementById("leaderSkillDecription").innerText =
					wholeData[currentDisplayCategory][id]["隊長技能"]["技能敘述"];
			} else {
				document.getElementById("leaderSkillArea").classList.add("hidden");
			}
		}

		function setWeaponSkill(id) {
			if (wholeData[currentDisplayCategory][id]["武器技能"]) {
				document.getElementById("weaponSkillArea").classList.remove("hidden");
				document.getElementById("weaponSkillName").innerText =
					wholeData[currentDisplayCategory][id]["武器技能"][0]["技能標題"];
				document.getElementById("weaponSkillDecription").innerText =
					wholeData[currentDisplayCategory][id]["武器技能"][0]["技能敘述"];
			} else {
				document.getElementById("weaponSkillArea").classList.add("hidden");
			}
		}

		function setActiveSkill(id) {
			if (wholeData[currentDisplayCategory][id]["主動技能"]) {
				document.getElementById("activeSkillArea").classList.remove("hidden");
				document.getElementById("activeSkillContent").innerHTML = "";

				for (const [index, mySkill] of wholeData[currentDisplayCategory][id]["主動技能"].entries()) {
					const templateActiveSkill = document.getElementById("template-activeSkill").content.cloneNode(true);
					templateActiveSkill.querySelector(".activeSkillDetail").id = "activeSkill_" + (index + 1);
					templateActiveSkill.querySelector(".activeSkillName").innerText = mySkill["技能標題"];
					templateActiveSkill.querySelector(".activeSkillSpirit").innerText = "靈氣 " + mySkill["靈氣"];
					templateActiveSkill.querySelector(".activeSkillTU").innerText = mySkill["TU"] + " TU";
					templateActiveSkill.querySelector(".activeSkillDecription").innerText = mySkill["技能敘述"];

					document.getElementById("activeSkillContent").appendChild(templateActiveSkill);
				}
			} else {
				document.getElementById("activeSkillArea").classList.add("hidden");
			}
		}

		function setPassiveSkill(id) {
			if (wholeData[currentDisplayCategory][id]["被動技能"]) {
				document.getElementById("passiveSkillArea").classList.remove("hidden");
				document.getElementById("passiveSkillContent").innerHTML = "";

				for (const [index, mySkill] of wholeData[currentDisplayCategory][id]["被動技能"].entries()) {
					const templateActiveSkill = document.getElementById("template-passiveSkill").content.cloneNode(true);
					templateActiveSkill.querySelector(".passiveSkillDetail").id = "passiveSkill_" + (index + 1);
					templateActiveSkill.querySelector(".passiveSkillName").innerText = mySkill["技能標題"];
					templateActiveSkill.querySelector(".passiveSkillDecription").innerText = mySkill["技能敘述"];

					document.getElementById("passiveSkillContent").appendChild(templateActiveSkill);
				}
			} else {
				document.getElementById("passiveSkillArea").classList.add("hidden");
			}
		}

		function setGachaIntro(id) {
			if (wholeData[currentDisplayCategory][id]["召喚導言"]) {
				document.getElementById("gachaIntroArea").classList.remove("hidden");
				document.getElementById("gachaIntroText").innerText = wholeData[currentDisplayCategory][id]["召喚導言"];
			} else {
				document.getElementById("gachaIntroArea").classList.add("hidden");
			}
		}

		function setDialog(id) {
			if (wholeData[currentDisplayCategory][id]["對話"]) {
				document.getElementById("dialogArea").classList.remove("hidden");
				document.getElementById("dialogContent").innerHTML = "";

				const dailogSort = {
					Gacha: "召喚",
					Login: "主畫面登入",
					Tap: "主畫面點擊",
					Idle: "主畫面閒置",
				};

				for (const [key, title] of Object.entries(dailogSort)) {
					if (!wholeData[currentDisplayCategory][id]["對話"][title]) continue;

					const templateDialog = document.getElementById("template-dialog").content.cloneNode(true);
					templateDialog.querySelector(".dialogGroup").id = "dialog_" + key;
					templateDialog.querySelector(".dialogGroupTitle").innerText = title;

					for (const dialogText of wholeData[currentDisplayCategory][id]["對話"][title]) {
						if (!dialogText) continue;
						const templateDialogText = templateDialog.querySelector(".dialogText").cloneNode(true);
						templateDialogText.innerText = dialogText;
						templateDialog.querySelector(".dialogGroup").appendChild(templateDialogText);
					}
					//若無添加，則只有模板當初的2子元素
					if (templateDialog.querySelector(".dialogGroup").children.length <= 2) continue;

					templateDialog.querySelector(".dialogText").remove();
					document.getElementById("dialogContent").appendChild(templateDialog);
				}
			} else {
				document.getElementById("dialogArea").classList.add("hidden");
			}
		}

		function setAiLogic(id) {
			if (wholeData[currentDisplayCategory][id]["AI邏輯"]) {
				document.getElementById("aiLogicArea").classList.remove("hidden");
				//刪除最外層的{}，並統一減少1縮排
				let jsonText = JSON.stringify(wholeData[currentDisplayCategory][id]["AI邏輯"], null, "\t");
				jsonText = jsonText.split("\n").slice(1, -1);
				jsonText = jsonText.map((line) => line.replace(/^\t/, ""));
				jsonText = jsonText.join("\n");

				document.getElementById("aiLogicContent").innerText = jsonText;
			} else {
				document.getElementById("aiLogicArea").classList.add("hidden");
			}
		}

		function getFullNameAddStarsOrRarity(id, category, addStars = true, addRarity = false) {
			let longName = wholeData[category][id]["完整名"];
			if (addStars) longName += ` (${wholeData[category][id]["星數"]})`;
			if (addRarity) longName += ` (${wholeData[category][id]["稀有度"]})`;
			return longName;
		}

		function analyzeUrlParams() {
			try {
				const params = new URLSearchParams(window.location.search);
				if (!params.toString()) return;
				history.replaceState(null, "", window.location.pathname);

				const id = params.get("id");
				let category = params.get("category");
				if (id || category) {
					if (!id && category) {
						//不能只有category
						throw new Error("id參數不可少");
					}

					if (id && !category) {
						//若沒傳入category則遍歷搜尋
						category = (() => {
							for (const [type, ids] of Object.entries(wholeData)) {
								if (id in ids) return type;
							}
							throw new Error("id參數錯誤");
						})();
					}

					if (wholeData?.[category]?.[id]) {
						displayData(id, category);
					} else {
						throw new Error("id或category參數錯誤");
					}
				}
			} catch (e) {
				alert(e);
				console.error(e);
			}
		}

		function setNameAndLink(id, category, addStars = true, addRarity = false) {
			const linkElement = document.createElement("a");
			linkElement.href = `?id=${id}&category=${category}`;
			linkElement.textContent = getFullNameAddStarsOrRarity(id, category, addStars, addRarity);
			return linkElement;
		}

		function setSummonableMonsters(id) {
			if (wholeData[currentDisplayCategory][id]["召喚物"]) {
				document.getElementById("summonableMonstersArea").classList.remove("hidden");
				const combination = wholeData[currentDisplayCategory][id]["召喚物"]
					.map((conjureID) => setNameAndLink(conjureID, "Monster", true, false).outerHTML)
					.join("<br>");
				document.getElementById("summonableMonstersContent").innerHTML = combination;
			} else {
				document.getElementById("summonableMonstersArea").classList.add("hidden");
			}
		}

		function setRelationship(id) {
			if (wholeData[currentDisplayCategory][id]["夥伴"]) {
				document.getElementById("relationshipArea").classList.remove("hidden");
				document.getElementById("relationshipContent").innerHTML = "";

				for (const oneRelationship of Object.values(wholeData[currentDisplayCategory][id]["夥伴"])) {
					const templateRelationship = document.getElementById("template-relationship").content.cloneNode(true);
					templateRelationship.querySelector(".relationshipName").innerText = oneRelationship["夥伴關係"];
					templateRelationship.querySelector(".relationshipBonus").innerText = oneRelationship["夥伴加成"].replace(
						"+",
						"\n+"
					);

					const memberlist = document.createElement("ul");
					for (const charID of oneRelationship["夥伴成員"]) {
						const listItem = document.createElement("li");
						listItem.appendChild(setNameAndLink(charID, "Monster", false, true));
						memberlist.appendChild(listItem);
					}
					templateRelationship.querySelector(".relationshipMembers").appendChild(memberlist);

					document.getElementById("relationshipContent").appendChild(templateRelationship);
				}
			} else {
				document.getElementById("relationshipArea").classList.add("hidden");
			}
		}

		function collapseContent(triggerElement) {
			triggerElement.innerText = !triggerElement.nextElementSibling.classList.contains("hidden") ? "⊕" : "⊖";
			triggerElement.nextElementSibling.classList.toggle("hidden");
		}

		function collapseReset() {
			document.querySelectorAll(".collapseButton").forEach(function (el) {
				el.nextElementSibling.classList.remove("hidden");
				el.innerText = "⊖";
			});
		}
	</script>
</body>

</html>